"use strict";function t(t){return t&&"object"==typeof t&&"default"in t?t.default:t}Object.defineProperty(exports,"__esModule",{value:!0});var e=require("react"),n=t(e),s=t(require("state-tracker")),r=t(require("invariant"));const o=()=>{},i={computation:null,dispatch:o,attachStoreName:o,useProxy:!0,namespace:null,patcher:null,trackerNode:null,useRelinkMode:!0,application:null};var c=e.createContext(i,()=>0);function a(...t){console.log("**DEBUG**",...t)}class h{constructor(t,e){this.prop=t||"root",this.parent=e,this.children={},this.patchers=[]}addPathNode(t,e){try{const n=t.length;t.reduce((t,s,r)=>{if(t.children[s]||(t.children[s]=new h(s,t)),r===n-1){const n=t.children[s];n.patchers&&(n.patchers.push(e),e.addRemover(()=>{const t=n.patchers.indexOf(e);-1!==t&&n.patchers.splice(t,1)}))}return t.children[s]},this)}catch(t){}}destroyPathNode(){try{this.patchers.forEach(t=>t.destroyPatcher()),this.children&&Object.keys(this.children).forEach(t=>{this.children[t].destroyPathNode()}),this.parent&&delete this.parent.children[this.prop]}catch(t){a("[PathNode destroy issue]",t)}}}const l=Function.call.bind(Object.prototype.toString),p=Object.prototype.hasOwnProperty;function u(t,e){return t===e?0!==t||0!==e||1/t==1/e:t!=t&&e!=e}class d{constructor({base:t,namespace:e,strictMode:n}){this.base=t,this.node=new h,this.pendingPatchers=[],this.namespace=e,this.strictMode=n,this.proxyState=s(this.base)}update(t){this.pendingPatchers=[];try{t.forEach(t=>this.treeShake(t)),t.forEach(t=>this.updateBase(t))}catch(t){a("[Application] update issue ",t)}this.pendingPatchers.forEach(({patcher:t})=>{t.triggerAutoRun()})}updateBase({storeKey:t,changedValue:e}){this.proxyState.relink([t],{...this.base[t]||{},...e})}addPatchers(t){t.length&&(t.forEach(t=>{this.pendingPatchers.push({patcher:t})}),t.forEach(t=>{t.markDirty()}))}treeShake({storeKey:t,changedValue:e}){const n=this.node.children[t],s=this.base[t],r={...s,...e};if(!n)return;const o=(t,e,n)=>{Object.keys(t.children).forEach(s=>{const r=e[s],i=n[s];var c,a;if(!function(t,e){if(u(t,e))return!0;if("object"!=typeof t||null===t||"object"!=typeof e||null===e)return!1;const n=Object.keys(t),s=Object.keys(e);if(n.length!==s.length)return!1;for(let s=0;s<n.length;s++)if(!p.call(e,n[s])||!u(t[n[s]],e[n[s]]))return!1;return!0}(r,i))if(c=i,l(r)!==l(c))this.addPatchers(t.children[s].patchers);else if(((t=>"[object Number]"===l(t))(a=i)||(t=>"[object String]"===l(t))(a)||(t=>"[object Boolean]"===l(t))(a))&&r!==i&&this.addPatchers(t.children[s].patchers),(t=>(t=>"[object Object]"===l(t))(t)||(t=>"[object Array]"===l(t))(t))(i))return void o(t.children[s],r,i)})};o(n,s,r),[].forEach(t=>t())}addPatcher(t){t.paths.forEach(e=>{this.node.addPathNode(e,t)})}getStoreData(t){return this.base[t]}}const f={},y=Math.pow(2,24),g={},m=({namespace:t,componentName:e})=>{g[t]||(g[t]={});const n=g[t][e]||0;return g[t][e]=n+1,`${t}_${e}_patcher_${n}`};class b{constructor(t){const e=t.models,n=t.initialValue||{};this._state={},this._reducers={},this._effects={},this._pendingActions=[],Object.keys(e).forEach(t=>{this.injectModel(t,e[t],n[t])}),this.dispatch=()=>{},this._application=null,this.subscriptions={},this._count=0}getState(){return this._state}getReducers(){return this._reducers}getEffects(){return this._effects}setValue(t){const e=[].concat(t).reduce((t,e)=>{if(!this._application)return[];const{type:n,payload:s}=e,[r,o]=n.split("/"),i=this._reducers[r];if(i)if(i[o]){const e=i[o](this._application.base[r],s);t.push({storeKey:r,changedValue:e})}else console.warn(`Do not have action '${o}'`);else this._pendingActions.push(e);return t},[]);if(e.length){var n,s,r;const t=e.reduce((t,e)=>{const{storeKey:n,changedValue:s}=e;return t[n]=s,t},{}),o={...null===(n=this._application)||void 0===n?void 0:n.base},i={...null===(s=this._application)||void 0===s?void 0:s.base,...t};null===(r=this._application)||void 0===r||r.update(e);for(let e in this.subscriptions)(0,this.subscriptions[e])({oldState:o,newState:i,diff:t})}}bindApplication(t){this._application=t}decorateDispatch(t){this.dispatch=t(this.setValue.bind(this))}generateSubscriptionKey(){return`store_${this._count++}`}subscribe(t){const e=this.generateSubscriptionKey();return this.subscriptions[e]=t,()=>delete this.subscriptions[e]}injectModel(t,e,n={}){var s,r;const{state:o,reducers:i={},effects:c={}}=e;let a=(null===(s=this._application)||void 0===s?void 0:s.getStoreData(t))||{...o,...n};const h=this._pendingActions.filter(e=>{const{type:n,payload:s}=e,[r,o]=n.split("/");if(t===r){const t=i[o],n=c[o];let r=a;"function"==typeof t?(r=t(a,s),a={...a,...r}):"function"==typeof n?this.dispatch(e):console.warn(`Maybe you have dispatched an unregistered model's effect action(${e})`)}return r!==t});this._state[t]=a,this._pendingActions=h,null===(r=this._application)||void 0===r||r.updateBase({storeKey:t,changedValue:a}),i&&(this._reducers[t]=i),c&&(this._effects[t]=c)}}class v{constructor(){this.collections=[]}addAction(t,e,n){this.collections.push({actionKey:t,namespace:e,remover:()=>{const e=this.collections.findIndex(({actionKey:e})=>e===t);-1!==e&&this.collections.splice(e,1)},actions:n})}}var x=new v;const S=t=>{[].concat(t).forEach(t=>{const{namespace:e,actions:n}=t;e||r(!1),n||r(!1);const s=Math.floor(Math.random()*y).toString(32);x.addAction(s,e,n)})},E=(t,e=2)=>`00${t}`.slice(-e),_=t=>{const e=new Date(t),n=e.getHours(),s=e.getMinutes(),r=e.getSeconds(),o=e.getMilliseconds();return`${E(n)}:${E(s)}:${E(r)}.${E(o,3)}`},w=Function.apply.bind(console.log,null),P=console.groupEnd,k=Function.apply.bind(console.groupCollapsed,null),j=t=>{const{text:e,styles:n}=t.reduce((t,e)=>{const{text:n,styles:s}=t,[r,o]=e;return{text:`${n}%c ${r}`,styles:[].concat(s,o)}},{text:"",styles:[]});return[e,...n]},R=t=>{const{type:e,actions:n={},effects:s={},payload:r,actionType:o}=t,i=Object.keys(n),c=Object.keys(s);(t=>{const{type:e,payload:n="",actionType:s="action",style:r}=t,o=[];e&&(o.push([s,"color: #eb2f96; font-weight: bold"]),o.push([e,"color: #722ed1; font-weight: bold"])),"line"===r?w([...j(o),n]):k([...j(o),n])})(i.length||c.length?{type:e,payload:r,actionType:o}:{type:e,payload:r,actionType:o,style:"line"}),i.forEach(t=>{R(n[t])}),c.forEach(t=>{R(s[t])}),(i.length||c.length)&&P()};class N{constructor({paths:t,autoRunFn:e,key:n,parent:s,displayName:r}){this.autoRunFn=e,this.paths=t,this.removers=[],this.dirty=!1,this.id=n,this.displayName=r,this.parent=s,this.children=[],this.parent&&this.parent.children.push(this)}destroyPatcher(){this.teardown(),this.children.length&&this.children.forEach(t=>t.destroyPatcher()),this.parent&&this.parent.removeChild(this),this.parent=null}appendTo(t){this.parent&&this.parent.removeChild(this),t&&(this.parent=t,-1===t.children.indexOf(this)&&t.children.push(this))}belongs(t){return!!t&&!!this.parent&&(this.parent===t||this.parent.belongs(t))}removeChild(t){const e=this.children.indexOf(t);-1!==e&&this.children.splice(e,1)}update({paths:t}){this.paths=t,this.dirty=!1,this.teardown()}addRemover(t){this.removers.push(t)}teardown(){this.removers.forEach(t=>t()),this.removers=[]}markDirty(){this.teardown()}markDirtyAll(){this.teardown(),this.children.length&&this.children.forEach(t=>t.markDirtyAll())}triggerAutoRun(){"function"==typeof this.autoRunFn&&this.autoRunFn()}}let O=0;const M=({addListener:t})=>(t(),null);exports.Provider=function({store:t,children:s,namespace:r,useProxy:o=!0,useRelinkMode:a=!0,strictMode:h=!1,useScope:l=!0}){const p=e.useRef(r||(()=>{let t;for(;void 0===t||f.hasOwnProperty(t)||!isNaN(+t);)t=Math.floor(Math.random()*y).toString(32);return f[t]=!0,t})()),u=e.useRef(new d({base:t.getState(),namespace:p.current,strictMode:h}));t.bindApplication(u.current);const g=t.dispatch,m=e.useRef({...i,dispatch:g,useProxy:o,useScope:l,useRelinkMode:a,namespace:p.current,application:u.current});return n.createElement(c.Provider,{value:m.current},s)},exports.applyMiddleware=function(...t){const e=[...t];return t=>n=>{const s=t(n),r=s.getState(),o={dispatch:(t,...e)=>s.dispatch(t,...e),getState:()=>r,store:s},i=e.map(t=>t(o));return s.decorateDispatch(function(...t){return 0===t.length?t=>t:1===t.length?t[0]:t.reduce((t,e)=>(...n)=>t(e(...n)))}(...i)),s}},exports.createStore=function t(e,n){return"function"==typeof n?n(t)(e):new b(e)},exports.logger=({getState:t})=>e=>n=>{if("function"!=typeof n){const s=Date.now(),r=JSON.parse(JSON.stringify(t()));e(n),(t=>{const{prevState:e={},actions:n}=t;(t=>{const{initialActions:e,startTime:n,endTime:s}=t;let r="";[].concat(e).slice(0,2).forEach(({type:t})=>{r=r?`${r}__${t}`:t}),e.length>2&&(r=`${r}...`);let o="color: #7cb305; font-weight: bold";r.startsWith("@init")&&(o="color: #ff4d4f; font-weight: bold");const i=[];i.push(["action",o]),i.push([r,"color: inherit;"]),i.push([`@ ${_(n)}`,"color: gray; font-weight: lighter;"]),i.push([`(${s-n}ms)`,"color: gray; font-weight: lighter;"]),k(j(i))})(t),((t,e=!1)=>{const n=[];let s="currentState",r="color: #4CAF50; font-weight: bold";e&&(s="nextState",r="color: #4CAF50; font-weight: bold"),n.push([s,r]),w([...j(n),t])})(e),(t=>{const e=t.filter(({type:t})=>!t.startsWith("@init"));e.forEach(t=>R(t)),e.length&&P()})(n),P()})({actions:n,prevState:r,initialActions:n,startTime:s,endTime:Date.now()})}},exports.observe=t=>{function s(r){const o=e.useRef(0),[i,a]=e.useState(0),h=e.useRef(0),l=e.useRef(!1);e.useEffect(()=>{l.current=!0});const{application:p,useProxy:u,useScope:d,namespace:f,patcher:y,useRelinkMode:g,...b}=e.useContext(c),v=e.useRef(O++),x=`${s.displayName}-${v.current}`,S=e.useRef();o.current+=1,S.current||(S.current=new N({paths:[],autoRunFn:()=>{l.current&&a(t=>t+1)},parent:y,key:m({namespace:f,componentName:x}),displayName:s.displayName})),null==p||p.proxyState.enter(x),e.useEffect(()=>()=>{S.current&&S.current.destroyPatcher()},[]);const E=e.useCallback(()=>{var t,e;null===(t=S.current)||void 0===t||t.appendTo(y);const n=null==p?void 0:p.proxyState.getContext().getCurrent().getRemarkable();null===(e=S.current)||void 0===e||e.update({paths:n}),S.current&&(null==p||p.addPatcher(S.current)),h.current+=1,null==p||p.proxyState.leave(x)},[]),_={...b,application:p,useProxy:u,useScope:d,namespace:f,useRelinkMode:g,patcher:S.current,componentName:x};return n.createElement(c.Provider,{value:_},n.createElement(n.Fragment,null,n.createElement(t,Object.assign({},r)),n.createElement(M,{addListener:E})))}return s.displayName=t.displayName||t.name||"ObservedComponent",n.memo(t=>n.createElement(s,Object.assign({},t)))},exports.thunk=({getState:t,dispatch:e,store:n})=>s=>(r,o)=>{if("function"==typeof r)return r(t=>{const n=([].concat(t)||[]).map(t=>{if(!t)return null;const{type:e,payload:n}=t,s={type:[o].concat(e.split("/")).slice(-2).join("/")};return n&&(s.payload=n),s}).filter(t=>!!t);n.length&&e&&e(n)},t);const i=[].concat(r),c=[],a=[];i.filter(t=>{if("[object Object]"===Object.prototype.toString.call(t)){const{type:e}=t;return!!e}return!1}).forEach((function(t){try{const{type:e}=t,s=e.split("/"),r=s[0],o=s[1],i=n.getEffects()[r];return i&&i[o]?a.push(t):c.push(t)}catch(t){return!1}})),c.length&&s(c),a.forEach(t=>{const{type:s,payload:r}=t,o=s.split("/"),i=o[0],c=o[1],a=n.getEffects()[i];e&&e((0,a[c])(r),i)})},exports.useDispatch=()=>{const{dispatch:t}=e.useContext(c);return[t]},exports.useGlobal=()=>[x.collections,S],exports.useNamespace=()=>{const{namespace:t}=e.useContext(c);return t},exports.useRelinx=t=>{const{dispatch:n,application:s,componentName:r}=e.useContext(c),o=(null==s?void 0:s.proxyState).peek([t]);return o.getTracker().setContext(r),[o,n]};
//# sourceMappingURL=relinx.cjs.production.min.js.map
