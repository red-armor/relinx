"use strict";function t(t){return t&&"object"==typeof t&&"default"in t?t.default:t}Object.defineProperty(exports,"__esModule",{value:!0});var e=require("react"),n=t(e),s=t(require("state-tracker")),r=t(require("invariant"));const i=()=>{},o={computation:null,dispatch:i,attachStoreName:i,useProxy:!0,namespace:null,patcher:null,trackerNode:null,useRelinkMode:!0,application:null};var a,c=e.createContext(o,()=>0);function h(...t){console.log("**DEBUG**",...t)}!function(t){t.Patchers="patchers",t.AutoRunners="autoRunners"}(a||(a={}));class u{constructor(t,e){this.prop=t||"root",this.parent=e,this.children={},this.patchers=[],this.autoRunners=[]}addPatcher(t,e){this.addPathNode(t,e,a.Patchers)}destroyPatcher(){}addAutoRunner(t,e){this.addPathNode(t,e,a.AutoRunners)}destroyAutoRunner(){}getCollection(t){return t===a.Patchers?this.patchers:this.autoRunners}addPathNode(t,e,n){try{const s=t.length;t.reduce((t,r,i)=>{if(t.children[r]||(t.children[r]=new u(r,t)),i===s-1){const s=t.children[r].getCollection(n);s&&(s.push(e),e.addRemover(()=>{const t=s.indexOf(e);-1!==t&&s.splice(t,1)}))}return t.children[r]},this)}catch(t){}}destroyPathNode(){try{this.patchers.forEach(t=>t.destroyPatcher()),this.children&&Object.keys(this.children).forEach(t=>{this.children[t].destroyPathNode()}),this.parent&&delete this.parent.children[this.prop]}catch(t){h("[PathNode destroy issue]",t)}}}const l=Function.call.bind(Object.prototype.toString),p=Object.prototype.hasOwnProperty;function d(t,e){return t===e?0!==t||0!==e||1/t==1/e:t!=t&&e!=e}class f{constructor({base:t,namespace:e,strictMode:n}){this.base=t,this.node=new u,this.autoRunnerNode=new u,this.pendingPatchers=[],this.pendingAutoRunners=[],this.pendingCleaner=[],this.namespace=e,this.strictMode=n,this.proxyState=s(this.base)}processAutoRunner(t){this.pendingAutoRunners=[];try{t.forEach(t=>this.treeShakeAutoRunner(t))}catch(t){h("[Application] processAutoRunner issue ",t)}}update(t){try{t.forEach(t=>this.treeShake(t)),t.forEach(t=>this.updateBase(t))}catch(t){h("[Application] update issue ",t)}this.pendingPatchers.forEach(({patcher:t})=>{t.triggerAutoRun()}),this.pendingPatchers=[],this.pendingAutoRunners=[],this.pendingCleaner.forEach(t=>t()),this.pendingCleaner=[]}updateDryRun(t){let e=[];try{t.forEach(t=>this.treeShake(t)),this.processAutoRunner(t),t.forEach(t=>this.updateBase(t)),this.pendingAutoRunners.forEach(({autoRunner:t})=>{e=e.concat(t.triggerAutoRun())})}catch(t){h("[Application] update issue ",t)}return e}updateBase({storeKey:t,changedValue:e}){this.proxyState.relink([t],{...this.base[t]||{},...e})}addPatchers(t){t.length&&(t.forEach(t=>{this.pendingPatchers.push({patcher:t})}),t.forEach(t=>{t.markDirty()}))}addAutoRunners(t){t.length&&(t.forEach(t=>{t.isDirty()||(this.pendingAutoRunners.push({autoRunner:t}),this.pendingCleaner.push(t.markClean.bind(t)))}),t.forEach(t=>{t.markDirty()}))}compare(t,e,n,s){Object.keys(t.children).forEach(r=>{const i=e[r],o=n[r];var a,c;if(!function(t,e){if(d(t,e))return!0;if("object"!=typeof t||null===t||"object"!=typeof e||null===e)return!1;const n=Object.keys(t),s=Object.keys(e);if(n.length!==s.length)return!1;for(let s=0;s<n.length;s++)if(!p.call(e,n[s])||!d(t[n[s]],e[n[s]]))return!1;return!0}(i,o))if(a=o,l(i)!==l(a))s(t.children[r]);else if(((t=>"[object Number]"===l(t))(c=o)||(t=>"[object String]"===l(t))(c)||(t=>"[object Boolean]"===l(t))(c))&&i!==o&&s(t.children[r]),(t=>(t=>"[object Object]"===l(t))(t)||(t=>"[object Array]"===l(t))(t))(o))return void this.compare(t.children[r],i,o,s)})}treeShakeAutoRunner({storeKey:t,changedValue:e}){const n=this.autoRunnerNode.children[t],s=this.base[t],r={...s,...e};n&&this.compare(n,s,r,t=>{this.addAutoRunners(t.autoRunners)})}treeShake({storeKey:t,changedValue:e}){const n=this.node.children[t],s=this.base[t],r={...s,...e};n&&this.compare(n,s,r,t=>{this.addPatchers(t.patchers)})}addPatcher(t){t.paths.forEach(e=>{this.node.addPatcher(e,t)})}addAutoRunner(t){t.paths.forEach(e=>{this.autoRunnerNode.addAutoRunner(e,t)})}getStoreData(t){return this.base[t]}}const y={},g=Math.pow(2,24),m={},R=({namespace:t,componentName:e})=>{m[t]||(m[t]={});const n=m[t][e]||0;return m[t][e]=n+1,`${t}_${e}_patcher_${n}`};let b=1;class v{constructor({paths:t,autoRunFn:e}){this.id=`autoRunner_${b++}`,this.paths=t,this.autoRunFn=e,this._isDirty=!1,this.removers=[]}addRemover(t){this.removers.push(t)}teardown(){this.removers.forEach(t=>t()),this.removers=[]}markDirty(){this._isDirty=!0}markClean(){this._isDirty=!1}isDirty(){return this._isDirty}triggerAutoRun(){return this.autoRunFn()||[]}}const A=(t,e)=>{e||r(!1);const n=e.proxyState;n.enter(),t({state:n});const s=n.getContext().getCurrent().getRemarkable(),i=new v({paths:s,autoRunFn:()=>t({state:n})});e.addAutoRunner(i),n.leave()};class _{constructor(t){const e=t.models,n=t.initialValue||{};this._state={},this._reducers={},this._effects={},this._pendingActions=[],this._pendingAutoRunInitializations=[],Object.keys(e).forEach(t=>{this.injectModel(t,e[t],n[t])}),this.dispatch=()=>{},this._application=null,this.subscriptions={},this._count=0}getState(){return this._state}getReducers(){return this._reducers}getEffects(){return this._effects}resolveActions(t){return t.reduce((t,e)=>{if(!this._application)return[];const{type:n,payload:s}=e,[r,i]=n.split("/"),o=this._reducers[r];if(o)if(o[i]){const e=o[i](this._application.base[r],s);t.push({storeKey:r,changedValue:e})}else console.warn(`Do not have action '${i}'`);else this._pendingActions.push(e);return t},[])}setValue(t){const e=[].concat(t),n=this.resolveActions(e);if(n.length){var s,r;const t=(null===(s=this._application)||void 0===s?void 0:s.updateDryRun(n))||[],e=this.resolveActions(t);null===(r=this._application)||void 0===r||r.update(e);const a=Object.keys(this.subscriptions),c=a.length;if(c){var i,o;const t=n.reduce((t,e)=>{const{storeKey:n,changedValue:s}=e;return t[n]={...t[n],...s},t},{}),e={...null===(i=this._application)||void 0===i?void 0:i.base},s={...null===(o=this._application)||void 0===o?void 0:o.base,...t};for(let n=0;n<c;n++)(0,this.subscriptions[a[n]])({oldState:e,newState:s,diff:t})}}}bindApplication(t){this._application=t,this.runPendingAutoRunInitialization()}runPendingAutoRunInitialization(){this._pendingAutoRunInitializations.length&&(this._pendingAutoRunInitializations.forEach(t=>{const{autoRunFn:e}=t;A(e,this._application)}),this._pendingAutoRunInitializations=[])}decorateDispatch(t){this.dispatch=t(this.setValue.bind(this))}generateSubscriptionKey(){return`store_${this._count++}`}subscribe(t){const e=this.generateSubscriptionKey();return this.subscriptions[e]=t,()=>delete this.subscriptions[e]}injectModel(t,e,n={}){var s,r;const{state:i,reducers:o={},effects:a={}}=e,c=e.subscriptions||{};let h=(null===(s=this._application)||void 0===s?void 0:s.getStoreData(t))||{...i,...n};const u=this._pendingActions.filter(e=>{const{type:n,payload:s}=e,[r,i]=n.split("/");if(t===r){const t=o[i],n=a[i];let r=h;"function"==typeof t?(r=t(h,s),h={...h,...r}):"function"==typeof n?this.dispatch(e):console.warn(`Maybe you have dispatched an unregistered model's effect action(${e})`)}return r!==t});Object.keys(c).forEach(e=>{const n=c[e];this._application?A(n,this._application):this._pendingAutoRunInitializations.push({modelKey:t,autoRunKey:e,autoRunFn:n})}),this._state[t]=h,this._pendingActions=u,null===(r=this._application)||void 0===r||r.updateBase({storeKey:t,changedValue:h}),o&&(this._reducers[t]=o),a&&(this._effects[t]=a)}}class E{constructor(){this.collections=[]}addAction(t,e,n){this.collections.push({actionKey:t,namespace:e,remover:()=>{const e=this.collections.findIndex(({actionKey:e})=>e===t);-1!==e&&this.collections.splice(e,1)},actions:n})}}var S=new E;const x=t=>{[].concat(t).forEach(t=>{const{namespace:e,actions:n}=t;e||r(!1),n||r(!1);const s=Math.floor(Math.random()*g).toString(32);S.addAction(s,e,n)})},k=(t,e=2)=>`00${t}`.slice(-e),P=t=>{const e=new Date(t),n=e.getHours(),s=e.getMinutes(),r=e.getSeconds(),i=e.getMilliseconds();return`${k(n)}:${k(s)}:${k(r)}.${k(i,3)}`},w=Function.apply.bind(console.log,null),j=console.groupEnd,N=Function.apply.bind(console.groupCollapsed,null),C=t=>{const{text:e,styles:n}=t.reduce((t,e)=>{const{text:n,styles:s}=t,[r,i]=e;return{text:`${n}%c ${r}`,styles:[].concat(s,i)}},{text:"",styles:[]});return[e,...n]},O=t=>{const{type:e,actions:n={},effects:s={},payload:r,actionType:i}=t,o=Object.keys(n),a=Object.keys(s);(t=>{const{type:e,payload:n="",actionType:s="action",style:r}=t,i=[];e&&(i.push([s,"color: #eb2f96; font-weight: bold"]),i.push([e,"color: #722ed1; font-weight: bold"])),"line"===r?w([...C(i),n]):N([...C(i),n])})(o.length||a.length?{type:e,payload:r,actionType:i}:{type:e,payload:r,actionType:i,style:"line"}),o.forEach(t=>{O(n[t])}),a.forEach(t=>{O(s[t])}),(o.length||a.length)&&j()};class D{constructor({paths:t,autoRunFn:e,key:n,parent:s,displayName:r}){this.autoRunFn=e,this.paths=t,this.removers=[],this.dirty=!1,this.id=n,this.displayName=r,this.parent=s,this.children=[],this.parent&&this.parent.children.push(this)}destroyPatcher(){this.teardown(),this.children.length&&this.children.forEach(t=>t.destroyPatcher()),this.parent&&this.parent.removeChild(this),this.parent=null}appendTo(t){this.parent&&this.parent.removeChild(this),t&&(this.parent=t,-1===t.children.indexOf(this)&&t.children.push(this))}belongs(t){return!!t&&!!this.parent&&(this.parent===t||this.parent.belongs(t))}removeChild(t){const e=this.children.indexOf(t);-1!==e&&this.children.splice(e,1)}update({paths:t}){this.paths=t,this.dirty=!1,this.teardown()}addRemover(t){this.removers.push(t)}teardown(){this.removers.forEach(t=>t()),this.removers=[]}markDirty(){this.teardown()}markDirtyAll(){this.teardown(),this.children.length&&this.children.forEach(t=>t.markDirtyAll())}triggerAutoRun(){"function"==typeof this.autoRunFn&&this.autoRunFn()}}let M=0;const $=({addListener:t})=>(t(),null);exports.Provider=function({store:t,children:s,namespace:r,useProxy:i=!0,useRelinkMode:a=!0,strictMode:h=!1,useScope:u=!0}){const l=e.useRef(r||(()=>{let t;for(;void 0===t||y.hasOwnProperty(t)||!isNaN(+t);)t=Math.floor(Math.random()*g).toString(32);return y[t]=!0,t})()),p=e.useRef();p.current||(p.current=new f({base:t.getState(),namespace:l.current,strictMode:h})),t.bindApplication(p.current);const d=t.dispatch,m=e.useRef({...o,dispatch:d,useProxy:i,useScope:u,useRelinkMode:a,namespace:l.current,application:p.current});return n.createElement(c.Provider,{value:m.current},s)},exports.applyMiddleware=function(...t){const e=[...t];return t=>n=>{const s=t(n),r=s.getState(),i={dispatch:(t,...e)=>s.dispatch(t,...e),getState:()=>r,store:s},o=e.map(t=>t(i));return s.decorateDispatch(function(...t){return 0===t.length?t=>t:1===t.length?t[0]:t.reduce((t,e)=>(...n)=>t(e(...n)))}(...o)),s}},exports.createStore=function t(e,n){return"function"==typeof n?n(t)(e):new _(e)},exports.logger=({getState:t})=>e=>n=>{if("function"!=typeof n){const s=Date.now(),r=JSON.parse(JSON.stringify(t()));e(n),(t=>{const{prevState:e={},actions:n}=t;(t=>{const{initialActions:e,startTime:n,endTime:s}=t;let r="";[].concat(e).slice(0,2).forEach(({type:t})=>{r=r?`${r}__${t}`:t}),e.length>2&&(r=`${r}...`);let i="color: #7cb305; font-weight: bold";r.startsWith("@init")&&(i="color: #ff4d4f; font-weight: bold");const o=[];o.push(["action",i]),o.push([r,"color: inherit;"]),o.push([`@ ${P(n)}`,"color: gray; font-weight: lighter;"]),o.push([`(${s-n}ms)`,"color: gray; font-weight: lighter;"]),N(C(o))})(t),((t,e=!1)=>{const n=[];let s="currentState",r="color: #4CAF50; font-weight: bold";e&&(s="nextState",r="color: #4CAF50; font-weight: bold"),n.push([s,r]),w([...C(n),t])})(e),(t=>{const e=t.filter(({type:t})=>!t.startsWith("@init"));e.forEach(t=>O(t)),e.length&&j()})(n),j()})({actions:n,prevState:r,initialActions:n,startTime:s,endTime:Date.now()})}},exports.observe=t=>{function s(r){const i=e.useRef(0),[o,a]=e.useState(0),h=e.useRef(0),u=e.useRef(!1);e.useEffect(()=>{u.current=!0});const{application:l,useProxy:p,useScope:d,namespace:f,patcher:y,useRelinkMode:g,...m}=e.useContext(c),b=e.useRef(M++),v=`${s.displayName}-${b.current}`,A=e.useRef();i.current+=1,A.current||(A.current=new D({paths:[],autoRunFn:()=>{u.current&&a(t=>t+1)},parent:y,key:R({namespace:f,componentName:v}),displayName:s.displayName})),null==l||l.proxyState.enter(v),e.useEffect(()=>()=>{A.current&&A.current.destroyPatcher()},[]);const _=e.useCallback(()=>{var t,e;null===(t=A.current)||void 0===t||t.appendTo(y);const n=null==l?void 0:l.proxyState.getContext().getCurrent().getRemarkable();null===(e=A.current)||void 0===e||e.update({paths:n}),A.current&&(null==l||l.addPatcher(A.current)),h.current+=1,null==l||l.proxyState.leave()},[]),E={...m,application:l,useProxy:p,useScope:d,namespace:f,useRelinkMode:g,patcher:A.current,componentName:v};return n.createElement(c.Provider,{value:E},n.createElement(n.Fragment,null,n.createElement(t,Object.assign({},r)),n.createElement($,{addListener:_})))}return s.displayName=t.displayName||t.name||"ObservedComponent",n.memo(t=>n.createElement(s,Object.assign({},t)))},exports.thunk=({getState:t,dispatch:e,store:n})=>s=>(r,i)=>{if("function"==typeof r)return r(t=>{const n=([].concat(t)||[]).map(t=>{if(!t)return null;const{type:e,payload:n}=t,s={type:[i].concat(e.split("/")).slice(-2).join("/")};return n&&(s.payload=n),s}).filter(t=>!!t);n.length&&e&&e(n)},t);const o=[].concat(r),a=[],c=[];o.filter(t=>{if("[object Object]"===Object.prototype.toString.call(t)){const{type:e}=t;return!!e}return!1}).forEach((function(t){try{const{type:e}=t,s=e.split("/"),r=s[0],i=s[1],o=n.getEffects()[r];return o&&o[i]?c.push(t):a.push(t)}catch(t){return!1}})),a.length&&s(a),c.forEach(t=>{const{type:s,payload:r}=t,i=s.split("/"),o=i[0],a=i[1],c=n.getEffects()[o];e&&e((0,c[a])(r),o)})},exports.useDispatch=()=>{const{dispatch:t}=e.useContext(c);return[t]},exports.useGlobal=()=>[S.collections,x],exports.useNamespace=()=>{const{namespace:t}=e.useContext(c);return t},exports.useRelinx=t=>{const{dispatch:n,application:s,componentName:r}=e.useContext(c),i=(null==s?void 0:s.proxyState).peek([t]);return i.getTracker().setContext(r),[i,n]};
//# sourceMappingURL=relinx.cjs.production.min.js.map
